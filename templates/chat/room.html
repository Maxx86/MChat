{% extends 'base.html' %}
{% block title %}–ß–∞—Ç - {{ room_name }}{% endblock %}
{% block content %}
<style>
/* === Aurora Glass Chat ‚Äî –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ —Ç–≤–æ–π HTML === */

/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
/* === Aurora Glass Background (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω) === */
body {
  margin: 0;
  height: 100vh;
  font-family: "Inter", sans-serif;
  color: #e2e8f0;
  background-color: #0f172a;
  background-image:
    radial-gradient(at 40% 20%, rgba(56,189,248,0.45) 0px, transparent 50%),
    radial-gradient(at 80% 0%, rgba(168,85,247,0.35) 0px, transparent 50%),
    radial-gradient(at 0% 50%, rgba(236,72,153,0.4) 0px, transparent 50%),
    radial-gradient(at 80% 50%, rgba(14,165,233,0.4) 0px, transparent 50%),
    radial-gradient(at 0% 100%, rgba(34,197,94,0.35) 0px, transparent 50%),
    radial-gradient(at 80% 100%, rgba(250,204,21,0.3) 0px, transparent 50%);
  background-attachment: fixed;
  background-size: 200% 200%;
  animation: auroraFlow 18s ease infinite;
}

@keyframes auroraFlow {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}


/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ */
.chat-wrapper {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  margin-top: 60px;
}
.chat-card {
  display: flex;
  flex-direction: row;
  width: 950px;
  max-width: 95%;
  min-height: 520px;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
  overflow: hidden;
}

/* –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —á–∞—Ç–∞ */
.chat-main {
  flex: 3;
  display: flex;
  flex-direction: column;
  padding: 25px;
  color: #f8fafc;
}
.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.chat-header h2 {
  margin: 0;
  color: #f8fafc;
  text-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
}
.chat-header button {
  background: linear-gradient(135deg, #38bdf8, #0ea5e9);
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-weight: bold;
  color: white;
  transition: 0.3s ease;
}
.chat-header button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 12px #38bdf8;
}

/* –ü–æ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏–π */
#chat-log {
  flex: 1;
  border: none;
  border-radius: 12px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #e2e8f0;
  resize: none;
  overflow-y: auto;
  font-size: 15px;
  font-family: "JetBrains Mono", monospace;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
  outline: none;
}

/* –í–≤–æ–¥ –∏ –∫–Ω–æ–ø–∫–∞ */
.chat-input {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}
#chat-message-input {
  flex: 1;
  padding: 10px 12px;
  border-radius: 10px;
  border: none;
  background: rgba(255, 255, 255, 0.12);
  color: #f8fafc;
  font-size: 15px;
  backdrop-filter: blur(5px);
}
#chat-message-input:focus {
  outline: 1px solid rgba(56,189,248,0.5);
  background: rgba(255, 255, 255, 0.18);
}
#chat-message-submit {
  background: linear-gradient(135deg, #06b6d4, #3b82f6);
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
  transition: 0.2s;
}
#chat-message-submit:hover {
  transform: scale(1.07);
  box-shadow: 0 0 10px #3b82f6;
}

/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.users-panel {
  flex: 1;
  background: rgba(255,255,255,0.08);
  border-left: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(20px);
  padding: 20px;
  display: flex;
  flex-direction: column;
  color: #f1f5f9;
}
.users-panel h3 {
  text-align: center;
  margin-bottom: 15px;
  color: #e0f2fe;
  text-shadow: 0 0 8px rgba(56,189,248,0.4);
}

/* –°–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
#user-list-online, #user-list-offline {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
}
#user-list-online li, #user-list-offline li {
  background: rgba(255,255,255,0.1);
  padding: 8px 12px;
  margin-bottom: 8px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(255,255,255,0.05);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: 0.25s ease;
}
#user-list-online li:hover, #user-list-offline li:hover {
  transform: scale(1.02);
  background: rgba(56,189,248,0.15);
}

/* –ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ */
.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
}
#user-list-online .status-dot {
  background: #22c55e;
  box-shadow: 0 0 6px #22c55e;
}
#user-list-offline .status-dot {
  background: #ef4444;
  opacity: 0.8;
}

/* –ò–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
.user-name {
  text-decoration: none;
  color: #e2e8f0;
  font-weight: 500;
}
.user-name:hover {
  text-shadow: 0 0 8px #38bdf8;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ */
.unread-indicator {
  margin-left: auto;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #f43f5e;
  animation: pulse 1.2s infinite ease-in-out;
}
@keyframes pulse {
  0% { transform: scale(0.8); opacity: 0.7; }
  50% { transform: scale(1); opacity: 1; }
  100% { transform: scale(0.8); opacity: 0.7; }
}
</style>


<div class="chat-wrapper">
    <div class="chat-card">
        <div class="chat-main">
            <div class="chat-header">
                <h2>üí¨ –ö–æ–º–Ω–∞—Ç–∞: {{ room_name }}</h2>
                <button onclick="window.location.href='/chat/global/'">üåç –û–±—â–∏–π —á–∞—Ç</button>
            </div>
            <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <b>{{ username }}</b></p>
            <textarea id="chat-log" readonly></textarea>
            <div class="chat-input">
                <input id="chat-message-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button id="chat-message-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div class="users-panel">
            <h3>–û–Ω–ª–∞–π–Ω</h3>
            <ul id="user-list-online" style="padding:0px;margin:0px;"></ul>

            <h3 style="margin-top:12px;">–û—Ñ–ª–∞–π–Ω</h3>
            <ul id="user-list-offline" style="padding:0px;margin:0px;"></ul>
        </div>
    </div>
</div>

<script>
    const currentUser = "{{ username }}";
    const roomName = "{{ room_name }}";
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

    /* === localStorage –¥–ª—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π === */
    const STORAGE_KEY = "unread_" + currentUser;
    function loadUnread() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
      catch { return {}; }
    }
    function saveUnread(obj) { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    function setUnread(user, value) {
      const store = loadUnread();
      if (value) store[user] = true;
      else delete store[user];
      saveUnread(store);
    }
    function hasUnread(user) {
      const store = loadUnread();
      return !!store[user];
    }

    /* === –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π === */
    function renderUsers(all, online) {
      const onlineSet = new Set(online || []);
      const list = document.querySelector("#user-list");
      list.innerHTML = "";
      all.forEach(u => {
        const li = document.createElement("li");
        li.dataset.username = u;

        // —Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω)
        const dot = document.createElement("span");
        dot.className = "status-dot";
        dot.style.backgroundColor = onlineSet.has(u) ? "#5F6F52" : "#B33A3A";
        li.appendChild(dot);

        // –∏–º—è
        if (u === currentUser) {
          const span = document.createElement("span");
          span.textContent = `${u} (–≤—ã)`;
          span.style.fontWeight = "bold";
          li.appendChild(span);
        } else {
          const link = document.createElement("a");
          link.href = "/chat/private/" + encodeURIComponent(u) + "/";
          link.textContent = u;
          link.className = "user-name";
          link.onclick = () => setUnread(u, false);
          li.appendChild(link);
        }

        // –∫—Ä–∞—Å–Ω–∞—è –º–∏–≥–∞—é—â–∞—è —Ç–æ—á–∫–∞ —Å–ø—Ä–∞–≤–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
        if (hasUnread(u)) {
          const alertDot = document.createElement("span");
          alertDot.className = "unread-indicator";
          li.appendChild(alertDot);
        }

        list.appendChild(li);
      });
    }

    /* === WebSocket === */
    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const chatLog = document.querySelector('#chat-log');

      if (data.type === 'chat') {
        chatLog.value += data.message + '\n';
        chatLog.scrollTop = chatLog.scrollHeight;
      }
      else if (data.type === 'user_list' || data.type === 'users') {
  // —Å–µ—Ä–≤–µ—Ä —à–ª—ë—Ç { type: "user_list", all: [...], online: [...] }
  const usersAll = Array.isArray(data.all) ? data.all : [];
  const onlineSet = new Set(Array.isArray(data.online) ? data.online : []);

  // —É–±–∏—Ä–∞–µ–º "System" –∏–∑ –æ–±–æ–∏—Ö —Å–ø–∏—Å–∫–æ–≤, –µ—Å–ª–∏ —Ç–∞–∫–æ–µ –∏–º—è –µ—Å—Ç—å
  const filteredAll = usersAll.filter(u => u && u !== 'System');

  const onlineUL  = document.getElementById('user-list-online');
  const offlineUL = document.getElementById('user-list-offline');
  if (!onlineUL || !offlineUL) return; // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –Ω–µ —É—Ä–æ–Ω–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

  onlineUL.innerHTML  = '';
  offlineUL.innerHTML = '';

  // –Ω–µ–±–æ–ª—å—à–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è <li>
  const makeItem = (u, isOnline) => {
    const li = document.createElement('li');
    li.setAttribute('data-username', u);

    // —Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    const dot = document.createElement('span');
    dot.className = 'status-dot';
    dot.style.backgroundColor = isOnline ? '#5F6F52' : '#B33A3A';
    li.appendChild(dot);

    // –ø–æ–¥–ø–∏—Å—å/—Å—Å—ã–ª–∫–∞
    if (u === currentUser) {
      const me = document.createElement('span');
      me.textContent = `${u} (–≤—ã)`;
      me.style.fontWeight = 'bold';
      li.appendChild(me);
    } else {
      const a = document.createElement('a');
      a.href = '/chat/private/' + encodeURIComponent(u) + '/';
      a.textContent = u;
      a.className = 'user-name';
      li.appendChild(a);
    }
    return li;
  };

  // —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –ø–æ —Å–ø–∏—Å–∫–∞–º
  filteredAll.forEach(u => {
    const isOnline = onlineSet.has(u);
    const li = makeItem(u, isOnline);
    (isOnline ? onlineUL : offlineUL).appendChild(li);
  });
}
      else if (data.type === 'private_alert') {
        if (data.target === currentUser) {
          setUnread(data.sender, true);
          const li = document.querySelector(`li[data-username="${data.sender}"]`);
          if (li && !li.querySelector('.unread-indicator')) {
            const alertDot = document.createElement('span');
            alertDot.className = 'unread-indicator';
            li.appendChild(alertDot);
          }
          notifySound.currentTime = 0;
          notifySound.play().catch(() => {});
        }
      }
    };

    chatSocket.onclose = () => console.error('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —á–∞—Ç–æ–º –∑–∞–∫—Ä—ã—Ç–æ.');

    /* === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π === */
    document.querySelector('#chat-message-submit').onclick = function() {
      const input = document.querySelector('#chat-message-input');
      const msg = input.value.trim();
      if (msg) {
        chatSocket.send(JSON.stringify({ message: msg }));
        input.value = '';
      }
    };

    document.querySelector('#chat-message-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è–ª—Å—è –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
        document.querySelector('#chat-message-submit').click(); // –∏–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
      }
    });

    /* === –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ª–∏—á–∫–∏ ‚Äî –æ—á–∏—â–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ === */
    (function clearIfPrivate() {
      if (roomName.startsWith("private_")) {
        const parts = roomName.replace("private_", "").split("_");
        const other = parts.find(n => n !== currentUser);
        if (other) {
          setUnread(other, false);
          const li = document.querySelector(`li[data-username="${other}"]`);
          if (li) {
            const alert = li.querySelector('.unread-indicator');
            if (alert) alert.remove();
          }
        }
      }
    })();
</script>
{% endblock %}
