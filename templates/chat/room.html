{% extends 'base.html' %}
{% block title %}–ß–∞—Ç - {{ room_name }}{% endblock %}
{% block content %}
<style>
  /* –§–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äì –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–≤–æ–π –Ω–µ–æ–Ω–æ–≤—ã–π */
  body {
    background: radial-gradient(at 30% 30%, rgba(99,102,241,0.45) 0%, transparent 60%),
                radial-gradient(at 70% 80%, rgba(56,189,248,0.4) 0%, transparent 60%),
                radial-gradient(at 90% 10%, rgba(168,85,247,0.25) 0%, transparent 50%),
                radial-gradient(at 10% 90%, rgba(236,72,153,0.35) 0%, transparent 60%),
                radial-gradient(at 50% 50%, rgba(15,23,42,1) 0%, rgba(2,6,23,1) 100%);
    background-attachment: fixed;
    background-size: 200% 200%;
    animation: auroraMove 22s ease-in-out infinite;
  }
  @keyframes auroraMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ ‚Äì —Å—Ç—Ä–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –∏ —Ç–æ–π –∂–µ —à–∏—Ä–∏–Ω—ã, —á—Ç–æ —É —Ö–µ–¥–µ—Ä–∞ */
  .chat-wrapper {
    width: var(--content-width);
    max-width: 95%;
    margin: 0 auto;
  }

  .chat-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 0 25px rgba(0,0,0,0.4);
    display: flex;
    overflow: hidden;
    height: calc(100vh - (64px + 24px) - 32px); /* —ç–∫—Ä–∞–Ω –º–∏–Ω—É—Å —Ö–µ–¥–µ—Ä –∏ –Ω–µ–±–æ–ª—å—à–∏–µ –ø–æ–ª—è */
    min-height: 520px;
  }

  .chat-main { flex: 3; display: flex; flex-direction: column; padding: 24px; color: #f8fafc; }
  .users-panel { flex: 1; background: rgba(255,255,255,0.08); border-left: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); padding: 20px; color:#f1f5f9; }

  .chat-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .chat-header h2 { margin:0; text-shadow:0 0 10px rgba(56,189,248,.6); }
  .chat-header button {
    background: linear-gradient(135deg,#38bdf8,#0ea5e9);
    border:0; border-radius:8px; padding:6px 12px; color:#fff; font-weight:700; cursor:pointer; transition:.2s;
  }
  .chat-header button:hover { transform:scale(1.05); box-shadow:0 0 12px #38bdf8; }

  #chat-log {
    flex: 1;
    display: flex; flex-direction: column; gap: 10px;
    padding: 15px; border-radius: 16px;
    background: rgba(255,255,255,0.10); color: #f1f5f9;
    overflow-y: auto; font-size: 15px; white-space: pre-wrap;
    box-shadow: inset 0 0 8px rgba(0,0,0,.2);
  }

  .message-bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; animation: fadeIn .25s ease; }
  .message-bubble.self  { align-self:flex-end; background: linear-gradient(135deg, rgba(56,189,248,.4), rgba(6,182,212,.25)); box-shadow: 0 0 10px rgba(56,189,248,.3); border-bottom-right-radius:4px; text-align:right; }
  .message-bubble.other { align-self:flex-start; background: rgba(255,255,255,.12); box-shadow: 0 0 10px rgba(255,255,255,.10); border-bottom-left-radius:4px; }
  .message-bubble.system{ align-self:center; background:transparent; color:#93c5fd; font-style:italic; font-size:14px; box-shadow:none; }

  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

  .chat-input { display:flex; gap:10px; margin-top:12px; }
  #chat-message-input {
    flex:1; padding:10px 12px; border-radius:10px; border:none;
    background: rgba(255,255,255,.12); color:#f8fafc;
  }
  #chat-message-input:focus { outline:1px solid rgba(56,189,248,.5); background: rgba(255,255,255,.18); }
  #chat-message-submit {
    background: linear-gradient(135deg,#06b6d4,#3b82f6); color:#fff; border:0; border-radius:10px; padding:10px 16px; font-weight:700; cursor:pointer;
    transition:.2s;
  }
  #chat-message-submit:hover { transform:scale(1.07); box-shadow:0 0 10px #3b82f6; }

  .users-panel h3 { text-align:center; margin:0 0 12px; color:#e0f2fe; text-shadow:0 0 8px rgba(56,189,248,.4); }
  #user-list-online, #user-list-offline { list-style:none; margin:0; padding:0; overflow-y:auto; }
  #user-list-online li, #user-list-offline li {
    background: rgba(255,255,255,.10); padding:8px 12px; margin-bottom:8px; border-radius:10px;
    display:flex; align-items:center; gap:8px; transition:.2s;
  }
  #user-list-online li:hover, #user-list-offline li:hover { transform: scale(1.02); background: rgba(56,189,248,.15); }

  .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
  #user-list-online .status-dot  { background:#22c55e; box-shadow:0 0 6px #22c55e; }
  #user-list-offline .status-dot { background:#ef4444; opacity:.85; }

  .user-name { text-decoration:none; color:#e2e8f0; font-weight:500; }
  .user-name:hover { text-shadow:0 0 8px #38bdf8; }

  .unread-indicator { margin-left:auto; width:8px; height:8px; border-radius:50%; background:#f43f5e; animation:pulse 1.2s infinite ease-in-out; }
  @keyframes pulse { 0%{transform:scale(.8);opacity:.7} 50%{transform:scale(1);opacity:1} 100%{transform:scale(.8);opacity:.7} }
</style>

<div class="chat-wrapper">
  <div class="chat-card">
    <div class="chat-main">
      <div class="chat-header">
        <h2>üí¨ –ö–æ–º–Ω–∞—Ç–∞: {{ room_name }}</h2>
        <button onclick="window.location.href='/chat/global/'">üåç –û–±—â–∏–π —á–∞—Ç</button>
      </div>

      <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <b>{{ username }}</b></p>

      <div id="chat-log"></div>

      <div class="chat-input">
        <input id="chat-message-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button id="chat-message-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="users-panel">
      <h3>–û–Ω–ª–∞–π–Ω</h3>
      <ul id="user-list-online"></ul>

      <h3 style="margin-top:12px;">–û—Ñ–ª–∞–π–Ω</h3>
      <ul id="user-list-offline"></ul>
    </div>
  </div>
</div>

<script>
  const currentUser = "{{ username }}";
  const roomName = "{{ room_name }}";
  const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

  const STORAGE_KEY = "unread_" + currentUser;
  const loadUnread = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } };
  const saveUnread = (obj) => localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  const setUnread = (user, v) => { const s = loadUnread(); v ? s[user]=true : delete s[user]; saveUnread(s); };
  const hasUnread = (user) => !!loadUnread()[user];

  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'chat') {
      const chatLog = document.querySelector('#chat-log');
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message-bubble');
      if (data.message.includes(currentUser + ':'))       msgDiv.classList.add('self');
      else if (data.message.startsWith('[') && data.message.includes('System')) msgDiv.classList.add('system');
      else                                                msgDiv.classList.add('other');
      msgDiv.textContent = data.message;
      chatLog.appendChild(msgDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    else if (data.type === 'user_list' || data.type === 'users') {
      const usersAll = Array.isArray(data.all) ? data.all : [];
      const online = new Set(Array.isArray(data.online) ? data.online : []);
      const filtered = usersAll.filter(u => u && u !== 'System');
      const onlineUL  = document.getElementById('user-list-online');
      const offlineUL = document.getElementById('user-list-offline');
      onlineUL.innerHTML = ''; offlineUL.innerHTML = '';

      const makeItem = (u, isOnline) => {
        const li = document.createElement('li'); li.dataset.username = u;
        const dot = document.createElement('span'); dot.className = 'status-dot';
        dot.style.backgroundColor = isOnline ? '#22c55e' : '#ef4444'; li.appendChild(dot);
        if (u === currentUser) { const me = document.createElement('span'); me.textContent = `${u} (–≤—ã)`; me.style.fontWeight='bold'; li.appendChild(me); }
        else { const a = document.createElement('a'); a.href = '/chat/private/' + encodeURIComponent(u) + '/'; a.textContent = u; a.className='user-name'; li.appendChild(a); }
        if (hasUnread(u)) { const alertDot = document.createElement('span'); alertDot.className='unread-indicator'; li.appendChild(alertDot); }
        return li;
      };

      filtered.forEach(u => (online.has(u) ? onlineUL : offlineUL).appendChild(makeItem(u, online.has(u))));
    }
    else if (data.type === 'private_alert') {
      if (data.target === currentUser) {
        setUnread(data.sender, true);
        const li = document.querySelector(`li[data-username="${data.sender}"]`);
        if (li && !li.querySelector('.unread-indicator')) {
          const dot = document.createElement('span'); dot.className='unread-indicator'; li.appendChild(dot);
        }
      }
    }
  };

  document.querySelector('#chat-message-submit').onclick = () => {
    const input = document.querySelector('#chat-message-input');
    const msg = input.value.trim();
    if (msg) { chatSocket.send(JSON.stringify({ message: msg })); input.value = ''; }
  };
  document.querySelector('#chat-message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.querySelector('#chat-message-submit').click(); }
  });

  // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–≤–∞—Ç–∫–∏ ‚Äî —Å–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
  (function clearIfPrivate() {
    if (roomName.startsWith("private_")) {
      const parts = roomName.replace("private_", "").split("_");
      const other = parts.find(n => n !== currentUser);
      if (other) {
        setUnread(other, false);
        const li = document.querySelector(`li[data-username="${other}"]`);
        if (li) { const alert = li.querySelector('.unread-indicator'); if (alert) alert.remove(); }
      }
    }
  })();
</script>
{% endblock %}
